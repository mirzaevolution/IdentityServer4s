<html>

<body>
	<h1>Hello</h1>
	<h2 id="info">...</h2>
	<div id="at" style="margin:20px"></div>
	<div id="result" style="margin:20px; font-size:25px;"></div>
	<div id="logout" style="margin:20px"></div>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/oidc-client/1.8.2/oidc-client.min.js"></script>
	<script>
		(async () => {

			const config = {
				authority: 'https://localhost:44344/',
				client_id: 'react',
				redirect_uri: 'https://localhost:44321/callback.html',
				popup_post_logout_redirect_uri: 'https://localhost:44321/logout.html',
				response_type: 'code',
				scope: 'openid profile email mcn.api offline_access'
			};


			const manager = new Oidc.UserManager(config);


			const user = await manager.getUser();
			if (user) {
				await userLoggedIn(user);
			}
			else {
				const infoElem = document.getElementById('info');
				infoElem.innerText = 'Redirecting in 3s...';
				setTimeout(async () => {
					try {
						const usr = await manager.signinPopup();
						await userLoggedIn(usr);
					} catch (error) {
						console.log(error);
					}
				}, 3000);
			}
			async function userLoggedIn(user) {
				addLogoutBtn();
				const infoElem = document.getElementById('info');
				infoElem.innerText = 'Welcome ' + user.profile.name;

				const tokenElem = document.getElementById('at');
				tokenElem.innerText = user.access_token;

				// call the API
				const response = await fetch('https://localhost:44395/api/test', {
					headers: {
						'Authorization': 'Bearer ' + user.access_token
					}
				});

				const data = await response.text();
				var obj = JSON.parse(data);
				document.getElementById('result').innerText = obj.message;
			}
			function addLogoutBtn() {
				const button = document.createElement('button');
				button.type = 'button';
				button.innerText = 'logout';
				button.style = 'width: 100px; height: 20px';
				button.onclick = logout;
				document.getElementById('logout').appendChild(button);
			}
			async function logout() {
				try {
					const result = await manager.signoutPopup();
				} finally {
					document.location.reload(true);
				}
			}
		})();
	</script>
</body>

</html>